
## 3.1 HTTPとセッション管理

* `Referer` ヘッダ
  - リンク元のURLを示す
  - フォームの送信や `a` 要素でのリンク移動のほか `img` 要素の `src` による画像への参照リクエストでもつく
  - URLにセッションIDなどの秘匿情報を含めてしまっている場合，この `Referer` ヘッダを経由して漏洩し，なりすましに使われる．
* **hiddenパラメータ**
  - `<input type="hidden" name="〈Name〉" value="〈Value〉">` でフォーム中に追加できる，GUI上はユーザに見えないパラメータ
  - ユーザが書き換えることはできるが，漏洩や第三者の書き換えに対しては堅牢．
  - 用途上クッキーやセッション変数と比較されることがある．
    * これらはセッションIDの固定化攻撃に対して脆弱．
    * ユーザに書き換えられては困る認証情報はセッション変数に保存すべし（→詳細は5.1節，5.3節）
    * セッション変数は **クッキーモンスターバグ** による漏洩に対する効果的対策がない状況がある（→詳細は4.6.4項）
* クッキー
  - サーバ側からレスポンスの `Set-Cookie` ヘッダで値を送ることによりクライアント側に値を覚えさせる機構．
  - ブラウザが一旦ドメインごとに対応するクッキー値を覚え，リクエストを投げる際にはその送信先のドメインに対応するクッキー値を `Cookie` ヘッダを入れて送る．
  - 長さに制限があり，またユーザが書き換えることもできるので，生のアプリケーションデータそのものを入れて使うことは普通しない．普通は “整理番号” を格納する．この整理番号を **セッションID** と呼ぶ．
  - セッションIDを管理する機構は脆弱性の温床なので，なるべく自作せず実績のある既存実装に頼ることが重要．
* セッションIDに求められる要件
  - 第三者がセッションIDを推測できないこと
    * 推測できると悪人がその推測可能なセッションIDをもつユーザになりすまして認証を通ってしまうため（66頁のなりすましの比喩的事例参照）
  - 第三者からセッションIDを強制されないこと
    * 強制可能な仕組みがあると **セッションIDの固定化攻撃** という手法でなりすましができてしまう（67-68頁の比喩的事例参照）
    * 認証のたびに新しいセッションIDに変更することで防げる．
* セッションIDが漏洩する原因
  - クッキー発行の際の **属性** の指定の不備
    * （これについてはすぐ下で後述）
  - ネットワークに仕掛けられた盗聴機構から漏れる（→8.3節）
    * これはTLSで暗号化して防げるが，それでも属性の指定には注意が必要
  - クロスサイトスクリプティングなど，アプリケーションの脆弱性により漏れる（→4章）
  - ブラウザの脆弱性により漏れる
  - （上で挙げた通り）URLに含めてしまっており `Referer` ヘッダから漏洩する（→4.6.3項）
* クッキーの属性
  - 以下の属性がセキュリティ上重要：
    * `Domain`
      - ブラウザがクッキー値を送信するドメイン．
      - デフォルトではレスポンスを返したサーバのドメインのみがクッキー値の送信対象になり，これが最も安全だが，複数のサーバに送信されるクッキー値を生成したい場合もあり，その際にはこの属性を使う．
      - 使用例： `Set-Cookie: x=123; Domain=example.jp`
      - `a.example.jp` が `Domain=example.jp` を指定して `b.example.jp` にもクッキー値が送られるようにすることはできるが，`Domain=foo.com` のように自身の接尾辞ではない “本当に関係ないドメイン” を指定することはできない．
        * そういった指定はブラウザ側が無視する．
        * 指定できてしまうとセッションIDの固定化攻撃の脆弱性となるため．
      - しかし `a.example.jp` と `b.example.jp` のようなドメインでも互いに運営者が違うことはあり，`Domain=example.jp` と設定すると前者のクッキーは後者に漏洩してしまうことになる．そのため，**基本的には `Domain` 属性は設定するものではない**．
        * 古いブラウザだと `Domain=co.jp` というドメインのクッキーが作れてしまう問題があり，例えば `yahoo.co.jp` から `amazon.co.jp` に簡単にセッションIDが漏れ得た．これは **クッキーモンスターバグ** (*Cookie Monster Bug*) と呼ばれる．
        * 地域型JPドメインと都道府県型JPドメインには案外最近のバージョンのブラウザまでクッキーモンスターバグがあった．これらのドメインを使う場合は固定化攻撃の対策に特に慎重を期する．
    * `Secure`
      - HTTPSの場合のみクッキーを送信するという指定．
      - →4.8.2項
    * `HttpOnly`
      - JavaScriptからこの属性にアクセスできるか否かの指定．
      - 固定化攻撃では，典型的には後述される **クロスサイトスクリプティング攻撃** によりJavaScriptを悪用してクッキーを盗み出すが，この属性をつけておくとその典型例に対して効果がある．
        * ただし全てのクロスサイトスクリプティング攻撃をこれで防げるわけではない．


## 3.2 受動的攻撃と同一オリジンポリシー

* 攻撃の種別
  - **能動的攻撃**： 攻撃者が直接攻撃対象のサーバに対してアクセスし改竄や漏洩などを試みること．
    * SQLインジェクションなど
  - **受動的攻撃**： Webサイト利用者に対して罠を仕掛けることにより，罠を閲覧したユーザを通してアプリケーションに攻撃を仕掛けようと試みること．
* 受動的攻撃の種別
  - 単純なもの
    * 罠サイトを開設し，ブラウザやプラグインなどの脆弱性を突くようなレスポンスを返すことで攻撃する．
  - 正規サイトの悪用
    * 正規サイトに何らかの不正操作を行ない（この段階だけ見ると能動的攻撃でもある），正規サイトにアクセスした閲覧者に攻撃の仕掛けられたレスポンスを返す．
    * 攻撃者から見れば，罠サイトに誘導する手間が要らない，利用者が多いと攻撃対象が拡大しやすい，などの利点がある．
    * よくある手法：
      - FTPのパスワードを不正入手しコンテンツを書き換える（→ 8.1節）
      - Webサーバの脆弱性を突いてコンテンツを書き換える（→ 8.1節）
      - SQLインジェクション（→ 4.4節）
      - SNSなどユーザが投稿できる機能のクロスサイトスクリプティング脆弱性につけこむ（→ 4.3節）
  - サイトをまたがるもの
    * 罠サイトを開設し，正規サイトへの攻撃となるリクエストを含むレスポンスを返すことで攻撃する．
    * 単に攻撃用のHTMLのURLが掲示板に貼られるなどの単純なものも多い．
    * よくある手法：
      - **クロスサイトリクエストフォージェリ** (CSRF)（→ 4.5節）
      - クロスサイトスクリプティング (XSS)（→ 4.3節，4.5節）
      - **HTTPヘッダインジェクション**（→ 4.7節）
* 受動的攻撃を防ぐ方法
  - ブラウザとWebサイトそれぞれが脆弱性を含まないようにする必要がある．
  - ブラウザによる対策： JavaScriptのサンドボクシング
    * ローカルファイルへのアクセスの禁止
    * **同一生成元ポリシー** (*same origin policy*)
      - 或るサイトが生成してクライアント側に送ったJavaScriptからは，別のサイトが生成してクライアント側に送ったDOMなどへの読み取りアクセスを禁止するセキュリティ上の制限．
      - これがないと，例えば悪意のあるサイトが `iframe` 要素で別サイトのページを読み込むことでそのページが取り扱うパスワードなどの内容をいくらでも取り出せてしまう．
      - 同一生成元であるとは以下の全てが一致している場合：
        * URLのホスト（つまりFQDN）
        * スキーム（プロトコル）
          - したがって同一のFQDNからでも例えばHTTPとHTTPSとでは異なる生成元とみなす．
        * ポート番号
      - Ajaxの `XMLHttpRequest` でアクセスできるURLにも同一生成元ポリシーが課されるが，これについては相手側のサイトが許可すれば同一生成元でなくても通信できる **CORS** という規格がある（→ 3.3節）．
      - “`iframe` 要素の内側にJavaScriptを送って実行させる攻撃” （**クロスサイトスクリプティング**）ができるようになっているとこれは同一生成元ポリシーを以てしても防げない．
        * しかし実際にはアクセス解析用のソースやバナー広告，ブログパーツなど，第三者の提供するJavaScriptを許可せざるを得ない場合もある．これはサイト運営者または閲覧者がJavaScript提供元を信頼することで許可することになる．提供元が意図的に個人情報を収集していたり，提供元が意図しない動作が提供されたJavaScriptの脆弱性によって攻撃で差し替えられて発生したりするセキュリティ上の問題が頻繁に生じているので，慎重な判断を要する．このほか，ブラウザのアドオンにも同様の慎重さが必要（こちらはサイトが提供する通常のJavaScriptよりも強い権限で動作するのでさらに慎重を期する）．
      - `iframe` 以外でも
